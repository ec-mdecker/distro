<?php
/**
 * @file
 * Code for the Feature Basic Content feature.
 */

include_once 'feature_basic_content.features.inc';

/*
 * Implements hook_views_query_alter().
 */
function feature_basic_content_views_query_alter(&$view, &$query) {
  $displays = array(
    'block',
    'block_1',
    'block_2',
    'block_3',
    'block_4',
  );

  if (($view->name == 'basic_blocks_displays' || $view->name == 'basic_blocks_sort') && in_array($view->current_display, $displays)) {
    //copies the existing filters
    $single_page = $query->where[1];

    //changes the boolean value in the copied conditions. This sets the boolean condition to true
    $single_page['conditions'][3]['value'] = 1;
    //joins the two conditions. so that when the boolean is true, the contextual filter for 'per path' will match up
    $single_page['conditions'][] = $query->where[0]['conditions'][1];

    //joins the contextual filter for active trail with the condition that has the boolean as false
    $query->where[1]['conditions'][] = $query->where[0]['conditions'][0];
    //inserts the conditions from earlier for 'per path' into the query.
    $query->where[] = $single_page;

    //unsets the contextual filters
    unset($query->where[0]);

  }
}